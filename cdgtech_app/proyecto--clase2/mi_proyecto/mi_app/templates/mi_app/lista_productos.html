{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Productos y Clientes</title>
    <link rel="stylesheet" href="{% static 'mi_app/styles.css' %}">
    <link rel="icon" href="https://s1.npass.app/icons/127.0.0.1.png">
    <script src="{% static 'mi_app/scripts.js' %}"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

{% comment %} VER ESTA PARTE DEL CODIGO (SCRIP DE ABAJO) {% endcomment %}

<script>
    const socket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/productos/'
    );
    
    socket.onopen = function(e) {
        console.log("Conectado al WebSocket");
    };
    
    socket.onclose = function(e) {
        console.log("WebSocket cerrado");
    };
    
    socket.onerror = function(error) {
        console.error("Error en WebSocket:", error);
    };
</script>


<body>
    <h1>Gesti√≥n de Reparaciones</h1>

    <!-- PESTA√ëAS -->
    <div class="tabs">
        <div class="tab active" data-tab="productos" onclick="cambiarTab('productos')">Productos</div>
        <div class="tab" data-tab="clientes" onclick="cambiarTab('clientes')">Clientes</div>
    </div>

    <!-- TAB PRODUCTOS -->
    <div id="tab-productos" class="tab-content active">
        
        <!-- BOT√ìN Y FORMULARIO NUEVO PRODUCTO -->
        <div class="botones_barra_superior">
            <button class="boton_agregar" onclick="toggleFormulario('form-nuevo-producto')">‚ûï A√±adir nuevo producto</button>
            <form action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button class='boton_logout' type="submit">Cerrar sesi√≥n</button>
            </form>
        </div>
        <form id="form-nuevo-producto" onsubmit="crearProducto(event)" style="display: none;">
            {% csrf_token %}
            <label>Cliente (DNI o Nombre): 
                <input type="text" id="cliente-buscar" name="cliente-buscar" placeholder="Buscar cliente por DNI o nombre">
            </label>
            <div id="clientes-busqueda-resultados" style="display: none;"></div>
        
            <label>Si el cliente no est√°, ingrese el DNI manualmente:
                <input type="text" name="dni" pattern="\d{8}" placeholder="DNI (8 d√≠gitos)">
            </label>
        
            <label>Producto: <input type="text" name="producto" required></label>
            <label>Marca: <input type="text" name="marca" required></label>
            <label>Descripci√≥n del problema:
                <textarea name="descripcion_problema" required></textarea>
            </label>
            <button type="submit">A√±adir producto üßæ</button>
        </form>
        

        {% if productos %}
        <div class="tabla-productos">
            <div class="encabezado">
                <div>ID</div>
                <div>Ingreso</div>
                <div>Tel√©fono</div>
                <div>Cliente</div>
                <div>Producto</div>
                <div>Marca</div>
                <div>Estado</div>
                <div>Acciones</div>
            </div>

            {% for producto in productos %}
            <div class="fila estado-{{ producto.estado|slugify }}" id="fila-{{ producto.id }}" onclick="toggleDetalles({{ producto.id }})">

                <div>{{ producto.id }}</div>
                <div>{{ producto.fecha_ingreso|date:"d/m/Y" }}</div>
                <div>{{ producto.cliente.telefono }}</div>
                <div>{{ producto.cliente.nombre }} {{ producto.cliente.apellido }}</div>
                <div id="prod-nombre-{{ producto.id }}">{{ producto.producto }}</div>
                <div>{{ producto.marca }}</div>
                <div id="estado-{{ producto.id }}">{{ producto.estado|title }}</div>
                <div class="acciones">
                    <td class="acciones">
                    <!-- <div class="tooltip-container">
                        <i class="icono-nota">üìù</i>
                            <div class="tooltip-text">                     NO FUNCIONANDO
                                {{ producto.notas_tecnicas }}
                            </div>
                        </div>
                    </td> -->
                      
                    <!-- <button id="btn-detalle-{{ producto.id }}" onclick="toggleDetalles({{ producto.id }})">Ver m√°s üîΩ</button> -->
                    <a href="{% url 'generar_pdf' producto.id %}" class="btn-pdf" title="Generar PDF" target="_blank">üßæ</a>
                    <form action="{% url 'eliminar_orden' producto.id %}" method="post" onsubmit="return confirm('¬øEliminar esta orden?');">
                        {% csrf_token %}
                        <button type="submit" class="btn-eliminar">üóëÔ∏è</button>
                    </form>
                </div>
            </div>

            <!-- DETALLES -->
            <div id="detalle-{{ producto.id }}" class="detalle {{ producto.estado|slugify }}" style="display: none;">
                <div class="detalle-flex tres-columnas">
                    <!-- COLUMNA 1 -->
                    <div class="detalle-info">
                        <p><strong>Descripci√≥n completa:</strong> {{ producto.descripcion_problema }}</p>
                        <p><strong>Fecha De Ingreso:</strong> {{ producto.fecha_ingreso|date:"d/m/Y" }}</p>
                        <button onclick="mostrarFormulario({{ producto.id }})">Editar orden ‚úèÔ∏è</button>
                    </div>

                    <!-- COLUMNA 2: Notas t√©cnicas -->
                    <div class="detalle-notas">
                        <form onsubmit="guardarNotasTecnicas(event, {{ producto.id }})">
                            {% csrf_token %}
                            <label for="notas-{{ producto.id }}"><strong>Notas t√©cnicas:</strong></label>
                            <textarea id="notas-{{ producto.id }}" name="notas_tecnicas">{{ producto.notas_tecnicas }}</textarea>
                            <button type="submit">Guardar notas üõ†Ô∏è</button>
                        </form>
                    </div>

                    <!-- COLUMNA 3: Formulario edici√≥n -->
                    <div class="detalle-form">
                        <form id="form-editar-{{ producto.id }}" class="formulario-compacto" style="display: none;" onsubmit="enviarFormulario(event, {{ producto.id }})">
                            {% csrf_token %}
                            <label>Producto:
                                <input type="text" name="producto" value="{{ producto.producto }}">
                            </label>
                            <label>Marca:
                                <input type="text" name="marca" value="{{ producto.marca }}">
                            </label>
                            <label>Descripci√≥n:
                                <textarea name="descripcion_problema">{{ producto.descripcion_problema }}</textarea>
                            </label>
                            
                            <!-- Cambi√© 'td' por un div, ya que no parece ser parte de una tabla -->
                            <div class="estado-div">
                                <button type="submit" class="btn-guardar" data-id="{{ producto.id }}">Guardar</button>
                                
                                <div class="estado">
                                    <!-- Botones para cambiar estado -->
                                    <button type="button" class="boton_estado" onclick="cambiarEstado({{ producto.id }}, 'retroceder')">‚á¶</button>
                                    <button type="button" class="boton_estado" onclick="cambiarEstado({{ producto.id }}, 'avanzar')">‚á®</button>
                                    <p>Cambiar Estado</p>
                                </div>
                                
                            </div>
                        </form>
                    </div>
                    
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No hay productos cargados.</p>
        {% endif %}
    </div>

    <!-- TAB CLIENTES -->
    <div id="tab-clientes" class="tab-content">
        <div class="contenedor-nuevo-cliente">
            <button class="boton_agregar" onclick="toggleFormulario('form-nuevo-cliente')">‚ûï Agregar nuevo cliente</button>
            <form id="form-nuevo-cliente" onsubmit="crearCliente(event)" style="display: none;">
                {% csrf_token %}
                <label>DNI: <input type="text" name="dni" pattern="\d{8}" required></label>
                <label>Nombre: <input type="text" name="nombre" required></label>
                <label>Apellido: <input type="text" name="apellido" required></label>
                <label>Tel√©fono: <input type="text" name="telefono" required></label>
                <label>Email: <input type="text" name="email"></label>
                <button type="submit">Crear cliente ‚ûï</button>
            </form>
        </div>
    <div>
        

        {% if clientes %}
        <div class="tabla-clientes">
            <div class="encabezado">
                <div>ID</div>
                <div>Nombre y apellido</div>
                <div>DNI</div>
                <div>Tel√©fono</div>
                <div>Email</div>
            </div>

            {% for cliente in clientes %}
            <div class="fila" onclick="toggleDetallesCliente({{ cliente.id }})">
                <div id="cliente-id-{{ cliente.id }}">{{ cliente.id }}</div>
                <div id="cliente-nombre-{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</div>
                <div id="cliente-dni-{{ cliente.id }}">{{ cliente.dni }}</div>
                <div id="cliente-telefono-{{ cliente.id }}">{{ cliente.telefono }}</div>
                <div id="cliente-email-{{ cliente.id }}">{{ cliente.email }}</div>
            </div>
            
            <!-- DETALLE EDITABLE CLIENTE -->
            <div id="detalle-cliente-{{ cliente.id }}" class="detalle-cliente" style="display: none;">
                <form onsubmit="editarCliente(event, {{ cliente.id }})">
                    {% csrf_token %}
                    <label>Nombre:
                        <input type="text" name="nombre" value="{{ cliente.nombre }}">
                    </label>
                    <label>Apellido:
                        <input type="text" name="apellido" value="{{ cliente.apellido }}">
                    </label>
                    <label>DNI:
                        <input type="text" name="dni" id="dni-input-{{ cliente.id }}" value="{{ cliente.dni }}" oninput="validarDni({{ cliente.id }})">
                        <small id="dni-error-{{ cliente.id }}" class="error-text"></small>
                    </label>
                    <label>Tel√©fono:
                        <input type="text" name="telefono" value="{{ cliente.telefono }}">
                    </label>
                    <label>Email:
                        <input type="email" name="email" value="{{ cliente.email }}">
                    </label>
                    <button type="submit" id="btn-guardar-{{ cliente.id }}">Guardar cambios üíæ</button>
                </form>
            </div>
            {% endfor %}
                 

        </div>
        {% else %}
        <p>No hay clientes cargados.</p>
        {% endif %}
    </div>
    <script src="{% static 'mi_app/scripts.js' %}"></script>
</body>

</html>
